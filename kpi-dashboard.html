<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Metrics Dashboard</title>
    
    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }
    </script>
    
    <script>
        // ******************************************************************
        // 1. GLOBAL VARIABLES & CONFIG
        // ******************************************************************
        
        // 1.1. Google Apps Script Web App URL
        // **!!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL Web App ‡∏ó‡∏µ‡πà Deploy ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì !!!**
        const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbxwisOTaPgHzM0EFby_Jxha4Cy3oKP-Tjq2YW9fnAY1ZJ8yz_iZQjita7naRggBbOSDNw/exec'; 

        // 1.2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
        const WARD_GROUPS = {
            '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°': [
                '13 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.3', '14 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.4', '15 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.5', '16 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.6',
                '90 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏á‡∏Ü‡πå‡∏≠‡∏≤‡∏û‡∏≤‡∏ò', '91 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏á‡∏Ü‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© 2+3', '11 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏ò‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏à 1',
                '18 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏ò‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏à 2', '40 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏•‡∏ò‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏á', '17 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏•‡∏ò‡∏≤‡∏£‡∏ö‡∏ô',
                '29 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Low Immune ‡∏ò‡∏ô‡∏á.4'
            ],
            '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°': [
                '22 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏ó‡∏±‡∏®‡∏ô‡πå 1', '24 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏ó‡∏±‡∏®‡∏ô‡πå 2', '39 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏ó‡∏±‡∏®‡∏ô‡πå 3', '25 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏ó‡∏±‡∏®‡∏ô‡πå 4',
                '27 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏à.7', '28 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏à.8', '94 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° Ex.9',
                '23 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ú‡∏•‡πÑ‡∏´‡∏°‡πâ', '34 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ö‡∏≥‡∏ö‡∏±‡∏î'
            ],
            '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏π‡∏ï‡∏¥-‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä': [
                '30 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î', '41 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä ‡∏ä‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå4', '42 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä ‡∏ä‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå4'
            ],
            '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏≠‡∏£‡πå‡πÇ‡∏ò‡∏õ‡∏¥‡∏î‡∏¥‡∏Å‡∏™‡πå': [
                '81 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏ä‡∏≤‡∏¢', '82 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏´‡∏ç‡∏¥‡∏á', '44 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° Ex.8'
            ],
            '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡πÇ‡∏™‡∏ï ‡∏®‡∏≠ ‡∏ô‡∏≤‡∏™‡∏¥‡∏Å ‡∏à‡∏±‡∏Å‡∏©‡∏∏': [
                '61 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç EENT ‡πÅ‡∏•‡∏∞‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å ‡∏ä‡∏ß.3', '10 ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏© EENT'
            ]
        };
        
        // 1.3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î KPI ‡∏ó‡∏±‡πâ‡∏á 10 ‡∏ï‡∏±‡∏ß
        const KPI_METRICS = [
            { code: 'KPI01', name: 'ü©∫ 1. ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏ú‡∏•‡∏Å‡∏î‡∏ó‡∏±‡∏ö', unit: '‡∏£‡∏≤‡∏¢‡∏ï‡πà‡∏≠ 100 ‡∏ß‡∏±‡∏ô‡∏ô‡∏≠‡∏ô', target: '< 1' },
            { code: 'KPI02', name: 'üíâ 2. ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏•‡∏±‡∏î‡∏ï‡∏Å‡∏´‡∏Å‡∏•‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', unit: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠ 1,000 ‡∏ß‡∏±‡∏ô‡∏ô‡∏≠‡∏ô', target: '< 1' },
            { code: 'KPI03', name: 'üëÅÔ∏è‚Äçüó®Ô∏è 3. ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤/‡∏™‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', unit: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠ 1,000 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏≤', target: '< 0.1' },
            { code: 'KPI04', name: 'üíä 4. ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏¢‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ö‡∏≥‡∏ö‡∏±‡∏î', unit: '%', target: '< 5%' },
            { code: 'KPI05', name: 'ü´Å 5. ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á', unit: '‡∏ï‡πà‡∏≠ 100 ‡∏ß‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏™‡∏≤‡∏¢', target: '< 2' },
            { code: 'KPI06', name: 'üßç‚Äç‚ôÄÔ∏è 6. ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', unit: '%', target: '‚â• 85%' },
            { code: 'KPI07', name: 'üïí 7. ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', unit: '‡∏ô‡∏≤‡∏ó‡∏µ', target: '‚â§ 30' },
            { code: 'KPI08', name: 'üìã 8. ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô', unit: '%', target: '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°' },
            { code: 'KPI09', name: 'üß† 9. ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô', unit: '%', target: '‚â• 90%' },
            { code: 'KPI10', name: 'üìö 10. ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£', unit: '%', target: '‚â• 80%' }
        ];

        // ******************************************************************
        // 2. CORE FUNCTIONS (Data Submission)
        // ******************************************************************

        /**
         * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• KPI ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
         */
        function sendKPIsToSheets(event) {
            event.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Form Submit ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
            
            const selectedWard = document.getElementById('wardSelect').value;
            const statusElement = document.getElementById('saveStatus');
            statusElement.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

            if (!selectedWard) {
                statusElement.innerHTML = '<span style="color: orange; font-weight: bold;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
                return;
            }
            
            // 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• KPI ‡∏à‡∏≤‡∏Å Form
            const kpiEntries = [];
            let validEntryCount = 0;
            
            KPI_METRICS.forEach(metric => {
                const inputElement = document.getElementById(metric.code);
                // ‡πÉ‡∏ä‡πâ value ‡∏à‡∏≤‡∏Å input field
                const value = inputElement ? parseFloat(inputElement.value) : NaN; 
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!isNaN(value) && inputElement.value !== "") {
                     kpiEntries.push({
                        // Tall Format Data Structure
                        WardName: selectedWard, 
                        KPICode: metric.code, 
                        KPIValue: value.toFixed(2),
                        KPIName: metric.name 
                    });
                    validEntryCount++;
                }
            });
            
            if (validEntryCount === 0) {
                 statusElement.innerHTML = '<span style="color: red; font-weight: bold;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ KPI ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß</span>';
                 return;
            }

            const payloadData = {
                'SourcePage': window.location.pathname,
                'DeviceType': navigator.userAgent,
                'kpiEntries': kpiEntries // Array ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Tall Format ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
            };

            // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
            fetch(GOOGLE_SHEETS_API_URL, {
                method: 'POST',
                mode: 'cors', 
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payloadData) 
            })
            .then(response => response.json())
            .then(data => {
                const rowCount = data.count || kpiEntries.length;
                statusElement.innerHTML = `<span style="color: green; font-weight: bold;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span> ${rowCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ${selectedWard} ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß`;
                document.getElementById('kpiForm').reset(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
            })
            .catch(error => {
                console.error('Error sending data to Google Sheets:', error);
                statusElement.innerHTML = `<span style="color: red; font-weight: bold;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span> (Error: ${error.message})`;
            });
        }


        // ******************************************************************
        // 3. UI GENERATION & EVENT HANDLERS
        // ******************************************************************

        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
         */
        function populateWardDropdown() {
            const groupSelect = document.getElementById('groupSelect');
            const wardSelect = document.getElementById('wardSelect');
            const selectedGroup = groupSelect.value;
            
            wardSelect.innerHTML = '<option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ---</option>'; // Reset
            wardSelect.disabled = true;

            if (selectedGroup && WARD_GROUPS[selectedGroup]) {
                WARD_GROUPS[selectedGroup].forEach(ward => {
                    const option = document.createElement('option');
                    option.value = ward;
                    option.textContent = ward;
                    wardSelect.appendChild(option);
                });
                wardSelect.disabled = false;
            }
        }
        
        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á Input Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å KPI 10 ‡∏ï‡∏±‡∏ß
         */
        function renderKPIInputs() {
            const container = document.getElementById('kpiInputsContainer');
            let html = '<div class="kpi-grid">';

            KPI_METRICS.forEach(metric => {
                html += `
                    <div class="kpi-input-group">
                        <label for="${metric.code}" title="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${metric.target}">${metric.name}</label>
                        <div class="input-with-unit">
                            <input type="number" step="0.01" id="${metric.code}" name="${metric.code}" 
                                   placeholder="‡πÉ‡∏™‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì" min="0">
                            <span class="unit-label">${metric.unit}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡∏Å Event Listener
         */
        function initializeDropdowns() {
            const groupSelect = document.getElementById('groupSelect');
            
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Option ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô
            Object.keys(WARD_GROUPS).forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });
            
            // 2. ‡∏ú‡∏π‡∏Å Event Listener
            document.getElementById('groupSelect').addEventListener('change', populateWardDropdown);
        }

        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            window.location.href = 'index.html';
        }
        
        // 4. Initialization
        window.onload = function() {
            initializeDropdowns(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô
            renderKPIInputs(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö KPI 10 ‡∏ï‡∏±‡∏ß
            
            // ‡∏ú‡∏π‡∏Å Event Listener Submit Form
            document.getElementById('kpiForm').addEventListener('submit', sendKPIsToSheets);

            window.logout = logout; 
        };
    </script>

    <style>
        /* CSS for aesthetics and layout */
        body { font-family: Tahoma, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .title-bar { font-size: 1.5em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .dashboard-box {
            background-color: #e0f7ff; border: 1px solid #b3e5fc; height: 100px; 
            display: flex; justify-content: center; align-items: center; margin-bottom: 20px; border-radius: 5px;
        }
        .dashboard-box h2 { font-size: 2.5em; color: #0277bd; font-weight: 600; }
        .content-section {
            background: #fff; padding: 25px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .logout-btn { 
            position: fixed; top: 20px; right: 20px; padding: 10px 15px; background-color: #dc3545; color: white; 
            border: none; border-radius: 4px; cursor: pointer; z-index: 1000;
        }
        .status-message { margin-top: 15px; padding: 10px; border: 1px dashed #aaa; background-color: #f9f9f9; }

        /* Form & Dropdown Styles */
        .form-header {
            display: flex; gap: 20px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee;
        }
        .form-header select {
            padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; font-size: 1em;
            background-color: #f9f9f9;
        }
        
        /* KPI Grid Styles */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive 3 columns */
            gap: 20px;
            padding: 20px 0;
            padding: 20px;
            border-radius: 5px;
        }
        .kpi-input-group label {
            display: block; font-weight: bold; margin-bottom: 5px; color: #0277bd; /* KPI Name color */
            font-size: 0.95em;
        }
        .input-with-unit {
            display: flex;
            align-items: center;
        }
        .input-with-unit input {
            padding: 10px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; flex-grow: 1;
        }
        .unit-label {
            padding: 10px; background-color: #e9e9e9; border: 1px solid #ddd; 
            border-left: none; border-radius: 0 4px 4px 0; color: #666;
            white-space: nowrap; 
            font-size: 0.9em;
        }

        #submitBtn {
            margin-top: 30px;
            padding: 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
        }
        #submitBtn:hover { background-color: #218838; }
    </style>
</head>
<body>

    <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

    <div class="container">
        
        <div class="title-bar">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏£‡∏∞‡∏Å‡∏¥‡∏à‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</div>

        <div class="dashboard-box"><h2>KPI-Dashboard</h2></div>

        <div class="content-section">
            <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î.</p>
            <hr>
            
            <form id="kpiForm">
                <div class="form-header">
                    <select id="groupSelect" required>
                        <option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô ---</option>
                        </select>
                    
                    <select id="wardSelect" required disabled>
                        <option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ---</option>
                    </select>
                </div>

                <div id="saveStatus" class="status-message">
                    ‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </div>

                <div id="kpiInputsContainer">
                    </div>

                <button type="submit" id="submitBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets)</button>
            </form>
            
            <hr style="margin-top: 30px;">
            <p style="font-size: 0.85em; color: #666;">**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:** ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Tall Format (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢, ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î, ‡∏Ñ‡πà‡∏≤) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Looker Studio ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏¢</p>
        </div>
        
    </div>
</body>
</html>
