<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• - ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #00897b;
            --primary-light: #4db6ac;
            --primary-dark: #005b4f;
            --secondary-color: #263238;
            --accent-color: #ffca28;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #37474f;
            --danger-color: #e53935;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #f4f7f6 0%, #e8f5e9 100%);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* --- Login Page Styles --- */
        #login-section {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-color) 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 20px;
        }

        .login-card h2 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .login-card p {
            color: #78909c;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .login-form .form-group {
            text-align: left;
            margin-bottom: 20px;
        }

        .login-form input {
            background: #f8f9fa;
        }

        .btn-login {
            width: 100%;
            justify-content: center;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 10px;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--secondary-color) 0%, #1a2327 100%);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text h2 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .logo-text p {
            font-size: 0.75rem;
            color: #b0bec5;
        }

        .nav-links {
            list-style: none;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            color: #b0bec5;
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            cursor: pointer;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0,137,123,0.3);
        }

        .nav-link i {
            width: 24px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .sidebar-footer {
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.8rem;
            color: #b0bec5;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
        }

        header {
            background: var(--card-bg);
            padding: 25px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.6rem;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }

        .header-title p {
            color: #78909c;
            font-size: 0.95rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .user-info {
            text-align: right;
        }

        .user-info h4 {
            font-size: 0.95rem;
            color: var(--secondary-color);
        }

        .user-info p {
            font-size: 0.8rem;
            color: #78909c;
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #78909c;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .stat-card .trend {
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .stat-card .trend.up {
            color: var(--success-color);
        }

        .stat-card .trend.down {
            color: var(--danger-color);
        }

        /* Content Cards */
        .content-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            font-size: 1.3rem;
            color: var(--primary-dark);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 0.95rem;
        }

        .required::after {
            content: ' *';
            color: var(--danger-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: #fafafa;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(0,137,123,0.1);
        }

        input:disabled {
            background: #f5f5f5;
            color: #9e9e9e;
            cursor: not-allowed;
        }

        .formula-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .formula-box h4 {
            color: var(--primary-dark);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .formula-box code {
            display: block;
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }

        .formula-box .variables {
            font-size: 0.85rem;
            color: #555;
        }

        .formula-box .variables p {
            margin: 3px 0;
        }

        .result-display {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }

        .result-display .label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .result-display .value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .result-display .target {
            font-size: 0.9rem;
            margin-top: 8px;
            opacity: 0.9;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-pass {
            background: #e8f5e9;
            color: var(--success-color);
        }

        .status-fail {
            background: #ffebee;
            color: var(--danger-color);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,137,123,0.3);
        }

        .btn-primary:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-edit {
            background: var(--accent-color);
            color: var(--secondary-color);
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid #eceff1;
        }

        th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 100%);
            color: var(--secondary-color);
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        tr:hover {
            background: #f5f5f5;
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-section input,
        .filter-section select {
            width: auto;
            min-width: 200px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--secondary-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 3000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.info { background: #0288d1; }

        .hidden { display: none !important; }

        .dimension-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dimension-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .dimension-stats {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            margin-top: 10px;
        }

        .stat .num {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat .label {
            font-size: 0.8rem;
            color: #78909c;
        }
    </style>
</head>
<body>

    <section id="login-section">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-hospital-user"></i>
            </div>
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</p>
            
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" required>
                </div>
                <div class="form-group">
                    <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                </div>
                <button type="submit" class="btn btn-primary btn-login">
                    <i class="fas fa-sign-in-alt"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
        </div>
    </section>

    <div id="main-app" class="hidden">
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-hospital-user"></i></div>
                <div class="logo-text">
                    <h2>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</h2>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</p>
                </div>
            </div>
            <ul class="nav-links">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard')">
                        <i class="fas fa-chart-line"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Dashboard)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('data-entry')">
                        <i class="fas fa-edit"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Entry)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('data-list')">
                        <i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (List)
                    </a>
                </li>
            </ul>
            <div style="margin-top: auto; padding: 10px;">
                <button class="btn btn-danger" onclick="logout()" style="width: 100%; justify-content: center; background: rgba(229, 57, 53, 0.1); border: 1px solid var(--danger-color);">
                    <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </nav>

        <main class="main-content">
            <header>
                <div class="header-title">
                    <h1 id="page-title">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</h1>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô 6 ‡∏°‡∏¥‡∏ï‡∏¥</p>
                </div>
                <div class="user-profile">
                    <div class="user-info">
                        <h4 id="display-user-name">‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û</h4>
                        <p>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                    </div>
                    <div class="avatar">PN</div>
                </div>
            </header>

            <section id="dashboard" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><i class="fas fa-list"></i> ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <div class="value" id="total-indicators">44</div>
                        <div class="trend up"><i class="fas fa-arrow-up"></i> 6 ‡∏°‡∏¥‡∏ï‡∏¥</div>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-calendar-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <div class="value" id="records-this-month">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success-color);">
                        <h3><i class="fas fa-check-circle"></i> ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
                        <div class="value" id="avg-compliance">0%</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--danger-color);">
                        <h3><i class="fas fa-exclamation-triangle"></i> ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå</h3>
                        <div class="value" id="below-target">0</div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h2><i class="fas fa-th-large"></i> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (6 ‡∏°‡∏¥‡∏ï‡∏¥)</h2>
                    </div>
                    <div class="dimension-grid" id="dimension-cards-container"></div>
                </div>
            </section>

            <section id="data-entry" class="content-section hidden">
                <div class="content-card">
                    <div class="card-header">
                        <h2><i class="fas fa-plus-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</h2>
                        <button class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-undo"></i> ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
                        </button>
                    </div>
                    <form id="indicator-form">
                        <input type="hidden" id="record-id">
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="entry-date" class="required">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                                <input type="month" id="entry-date" required>
                            </div>
                            <div class="form-group">
                                <label for="entry-ward" class="required">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ / ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                                <select id="entry-ward" required>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="entry-dimension" class="required">‡∏°‡∏¥‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</label>
                                <select id="entry-dimension" onchange="loadIndicatorsByDimension()" required>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏¥‡∏ï‡∏¥ --</option>
                                    <option value="1">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 1: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</option>
                                    <option value="2">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 2: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</option>
                                    <option value="3">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 3: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                                    <option value="4">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 4: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option>
                                    <option value="5">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 5: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option>
                                    <option value="6">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 6: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="entry-indicator" class="required">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</label>
                                <select id="entry-indicator" onchange="updateFormulaHint()" required disabled>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î --</option>
                                </select>
                            </div>
                        </div>

                        <div class="formula-box" id="formula-container" style="display: none;">
                            <h4><i class="fas fa-calculator"></i> ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h4>
                            <code id="formula-code"></code>
                            <div class="variables" id="formula-variables"></div>
                            <div class="result-display">
                                <div class="label">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
                                <div class="value" id="result-display">0.00%</div>
                                <div class="target" id="target-display">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: -</div>
                            </div>
                        </div>

                        <div class="form-grid" id="input-values-container">
                            <div class="form-group">
                                <label for="val-a" class="required">‡∏Ñ‡πà‡∏≤ A (‡∏ï‡∏±‡∏ß‡πÄ‡∏®‡∏©)</label>
                                <input type="number" id="val-a" step="0.01" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤" oninput="calculateResult()" required>
                            </div>
                            <div class="form-group">
                                <label for="val-b" class="required">‡∏Ñ‡πà‡∏≤ B (‡∏ï‡∏±‡∏ß‡∏™‡πà‡∏ß‡∏ô)</label>
                                <input type="number" id="val-b" step="0.01" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤" oninput="calculateResult()" required>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="entry-notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <textarea id="entry-notes" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                        </div>

                        <div style="text-align: right; margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="showSection('data-list')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="data-list" class="content-section hidden">
                <div class="content-card">
                    <div class="card-header">
                        <h2><i class="fas fa-table"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
                    </div>
                    
                    <div class="filter-section">
                        <input type="text" id="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="renderTable()">
                        <select id="filter-dimension" onchange="renderTable()">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡∏°‡∏¥‡∏ï‡∏¥</option>
                            <option value="1">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 1</option>
                            <option value="2">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 2</option>
                            <option value="3">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 3</option>
                            <option value="4">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 4</option>
                            <option value="5">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 5</option>
                            <option value="6">‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 6</option>
                        </select>
                        <select id="filter-ward" onchange="renderTable()">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</option>
                        </select>
                    </div>
                    
                    <div class="table-container">
                        <table id="data-table">
                            <thead>
                                <tr>
                                    <th>‡∏á‡∏ß‡∏î</th>
                                    <th>‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                                    <th>‡∏°‡∏¥‡∏ï‡∏¥</th>
                                    <th>‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</th>
                                    <th>‡∏Ñ‡πà‡∏≤ A</th>
                                    <th>‡∏Ñ‡πà‡∏≤ B</th>
                                    <th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="9" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // --- Configuration & Data ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBpnbe9Nb9ti4Ei--IhORGJu6DHX4EEjhIGSu0TvNIuZ_eMTFQEwq3JFxBS_pQeTys/exec';
        let records = [];

        const wards = [
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.3", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.4", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.5", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.6",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏á‡∏Ü‡πå‡∏≠‡∏≤‡∏û‡∏≤‡∏ò", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏á‡∏Ü‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© 2+3", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏ò‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏à 1",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏ò‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏à 2", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏•‡∏≤‡∏ó‡∏£‡∏•‡πà‡∏≤‡∏á",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏•‡∏≤‡∏ó‡∏£‡∏ö‡∏ô", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Low Immune ‡∏ò‡∏ô‡∏à.4",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 1", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 2", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 3", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 4",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏â.7", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏â.8", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° Ex.9",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ú‡∏•‡πÑ‡∏´‡∏°‡πâ", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Ñ‡∏°‡∏µ‡∏ö‡∏≥‡∏ö‡∏±‡∏î", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä ‡∏ä‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå4", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä ‡∏ä‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå4",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏ä‡∏≤‡∏¢", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏´‡∏ç‡∏¥‡∏á",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° Ex.8", "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç EENT ‡πÅ‡∏•‡∏∞‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å ‡∏ä‡∏ß.3",
            "‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏© EENT"
        ];

        const indicatorsDB = [
            { id: 101, dim: 1, name: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ó‡∏±‡∏®‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", target: 80, targetType: "gte", formula: "(A√ó100)/B", varA: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏", varB: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" },
            { id: 102, dim: 1, name: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏•‡∏î‡∏•‡∏á", target: 80, targetType: "gte", formula: "(A√ó100)/B", varA: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏•‡∏î", varB: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" },
            { id: 103, dim: 1, name: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°", target: 80, targetType: "gte", formula: "(A√ó100)/B", varA: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå", varB: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" },
            { id: 201, dim: 2, name: "‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (Productivity)", targetMin: 90, targetMax: 110, targetType: "range", formula: "(A√ó100)/B", varA: "‡∏ä‡∏°.‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", varB: "‡∏ä‡∏°.‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á" },
            { id: 301, dim: 3, name: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", target: 80, targetType: "gte", formula: "(A√ó100)/B", varA: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à", varB: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°" },
            { id: 401, dim: 4, name: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£", target: 80, targetType: "gte", formula: "(A√ó100)/B", varA: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô", varB: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°" },
            { id: 501, dim: 5, name: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á", target: 100, targetType: "gte", formula: "(A√ó100)/B", varA: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ñ‡∏π‡∏Å", varB: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" },
            { id: 611, dim: 6, name: "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏ú‡∏•‡∏Å‡∏î‡∏ó‡∏±‡∏ö‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", target: 0, targetType: "eq", formula: "(A√ó100)/B", varA: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡∏•‡πÉ‡∏´‡∏°‡πà", varB: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á" },
            { id: 612, dim: 6, name: "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", target: 0, targetType: "eq", formula: "(A√ó1000)/B", varA: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠", varB: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏≠‡∏ô‡∏£‡∏ß‡∏°" }
            // ... ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        ];

        // --- App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            populateWards();
            const now = new Date();
            document.getElementById('entry-date').value = now.toISOString().slice(0, 7);
        });

        function populateWards() {
            const selectEntry = document.getElementById('entry-ward');
            const selectFilter = document.getElementById('filter-ward');
            wards.forEach(w => {
                const opt1 = new Option(w, w);
                selectEntry.add(opt1);
                const opt2 = new Option(w, w);
                selectFilter.add(opt2);
            });
        }

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (user === 'admin' && pass === '1234') {
                showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('display-user-name').textContent = user;
                loadDataFromSheet();
            } else {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        });

        async function loadDataFromSheet() {
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                records = data.map(r => ({
                    ...r,
                    id: parseInt(r.id),
                    dim: parseInt(r.dim),
                    indId: parseInt(r.indId),
                    valA: parseFloat(r.valA),
                    valB: parseFloat(r.valB),
                    result: parseFloat(r.result),
                    isPass: r.isPass === true || r.isPass === 'true'
                }));
                updateDashboard();
                renderTable();
            } catch (error) {
                console.error(error);
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            if (event) event.currentTarget.classList.add('active');
            if (sectionId === 'dashboard') updateDashboard();
            if (sectionId === 'data-list') renderTable();
        }

        function loadIndicatorsByDimension() {
            const dim = document.getElementById('entry-dimension').value;
            const select = document.getElementById('entry-indicator');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î --</option>';
            select.disabled = !dim;
            if (dim) {
                indicatorsDB.filter(i => i.dim == dim).forEach(ind => {
                    select.add(new Option(`${ind.id}. ${ind.name}`, ind.id));
                });
            }
            updateFormulaHint();
        }

        function updateFormulaHint() {
            const indId = document.getElementById('entry-indicator').value;
            const container = document.getElementById('formula-container');
            if (!indId) { container.style.display = 'none'; return; }
            const ind = indicatorsDB.find(i => i.id == indId);
            container.style.display = 'block';
            document.getElementById('formula-code').textContent = ind.formula;
            document.getElementById('formula-variables').innerHTML = `<p>A = ${ind.varA}</p><p>B = ${ind.varB}</p>`;
            document.getElementById('target-display').textContent = `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${ind.target}%`;
            calculateResult();
        }

        function calculateResult() {
            const indId = document.getElementById('entry-indicator').value;
            const valA = parseFloat(document.getElementById('val-a').value) || 0;
            const valB = parseFloat(document.getElementById('val-b').value) || 0;
            if (!indId) return;
            const ind = indicatorsDB.find(i => i.id == indId);
            let res = 0;
            if (ind.formula.includes('1000')) res = valB ? (valA * 1000) / valB : 0;
            else if (ind.formula.includes('100')) res = valB ? (valA * 100) / valB : 0;
            else res = valB ? valA / valB : 0;
            document.getElementById('result-display').textContent = res.toFixed(2) + '%';
            document.getElementById('result-display').dataset.raw = res;
        }

        function checkStatus(res, ind) {
            if (ind.targetType === 'gte') return res >= ind.target;
            if (ind.targetType === 'lte') return res <= ind.target;
            if (ind.targetType === 'eq') return res == ind.target;
            if (ind.targetType === 'range') return res >= ind.targetMin && res <= ind.targetMax;
            return true;
        }

        // --- FIXED POST FUNCTION ---
        document.getElementById('indicator-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button[type="submit"]');
            const id = document.getElementById('record-id').value || Date.now();
            const indId = document.getElementById('entry-indicator').value;
            const indData = indicatorsDB.find(i => i.id == indId);
            const resRaw = parseFloat(document.getElementById('result-display').dataset.raw);

            const record = {
                id: id,
                date: document.getElementById('entry-date').value,
                ward: document.getElementById('entry-ward').value,
                dim: document.getElementById('entry-dimension').value,
                indId: indId,
                indName: indData.name,
                valA: document.getElementById('val-a').value,
                valB: document.getElementById('val-b').value,
                result: resRaw.toFixed(2),
                isPass: checkStatus(resRaw, indData),
                notes: document.getElementById('entry-notes').value
            };

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ CORS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£ Redirect error
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save', record: record })
                });

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                const idx = records.findIndex(r => r.id == id);
                if (idx > -1) records[idx] = record; else records.push(record);

                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                resetForm();
                showSection('data-list');
            } catch (err) {
                console.error(err);
                showToast('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        });

        async function deleteRecord(id) {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?')) return;
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                records = records.filter(r => r.id != id);
                renderTable();
                showToast('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } catch (e) { showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
        }

        function renderTable() {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            const search = document.getElementById('search-input').value.toLowerCase();
            const fDim = document.getElementById('filter-dimension').value;
            const fWard = document.getElementById('filter-ward').value;

            const filtered = records.filter(r => {
                const mSearch = r.indName.toLowerCase().includes(search) || r.ward.toLowerCase().includes(search);
                const mDim = fDim === 'all' || r.dim == fDim;
                const mWard = fWard === 'all' || r.ward == fWard;
                return mSearch && mDim && mWard;
            });

            filtered.sort((a,b) => b.id - a.id).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.date}</td>
                    <td>${r.ward}</td>
                    <td>${r.dim}</td>
                    <td>${r.indName}</td>
                    <td>${r.valA}</td>
                    <td>${r.valB}</td>
                    <td style="font-weight:bold; color:${r.isPass ? 'green' : 'red'}">${r.result}%</td>
                    <td>${r.isPass ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRecord(${r.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateDashboard() {
            document.getElementById('records-this-month').textContent = records.length;
            const pass = records.filter(r => r.isPass).length;
            const rate = records.length ? Math.round((pass/records.length)*100) : 0;
            document.getElementById('avg-compliance').textContent = rate + '%';
            document.getElementById('below-target').textContent = records.length - pass;
            
            const container = document.getElementById('dimension-cards-container');
            container.innerHTML = '';
            [1,2,3,4,5,6].forEach(d => {
                const count = records.filter(r => r.dim == d).length;
                container.innerHTML += `<div class="dimension-card"><h3>‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà ${d}</h3><div class="dimension-stats"><div class="stat"><div class="num">${count}</div><div class="label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div></div></div></div>`;
            });
        }

        function resetForm() {
            document.getElementById('indicator-form').reset();
            document.getElementById('record-id').value = '';
            document.getElementById('formula-container').style.display = 'none';
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>
