<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจัดการข้อมูลลูกค้า ABC</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://rsms.me/inter/inter.css');
    html { 
      font-family: 'Inter', sans-serif; 
      scroll-behavior: smooth;
    }
    @supports (font-variation-settings: normal) {
      html { font-family: 'Inter var', sans-serif; }
    }
    /* ซ่อน scrollbar แต่ยังเลื่อนได้ (สำหรับตารางบนมือถือ) */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="bg-gray-100">

  <!-- Form Container -->
  <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl my-8 mx-auto" id="form-section">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">ระบบจัดการข้อมูลลูกค้า</h1>
      <p class="text-gray-600 mt-2">บริษัท ABC จำกัด</p>
    </div>

    <!-- ฟอร์มสำหรับกรอกข้อมูล -->
    <form id="customerForm">
      <!-- [NEW] Hidden input สำหรับเก็บ Row ID ตอนแก้ไข -->
      <input type="hidden" id="editingRowId" name="editingRowId">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- ชื่อ -->
        <div>
          <label for="firstName" class="block text-sm font-medium text-gray-700">ชื่อ</label>
          <input type="text" id="firstName" name="firstName" required
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <!-- สกุล -->
        <div>
          <label for="lastName" class="block text-sm font-medium text-gray-700">สกุล</label>
          <input type="text" id="lastName" name="lastName" required
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <!-- เบอร์โทร -->
        <div class="md:col-span-1">
          <label for="phone" class="block text-sm font-medium text-gray-700">เบอร์โทร</label>
          <input type="tel" id="phone" name="phone"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <!-- อีเมล -->
        <div class="md:col-span-1">
          <label for="email" class="block text-sm font-medium text-gray-700">อีเมล</label>
          <input type="email" id="email" name="email" required
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <!-- ประเภทลูกค้า -->
        <div class="md:col-span-2">
          <label for="customerType" class="block text-sm font-medium text-gray-700">ประเภทลูกค้า</label>
          <select id="customerType" name="customerType" required
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <option value="normal">Normal</option>
            <option value="vip">VIP</option>
          </select>
        </div>
        <!-- หมายเหตุ -->
        <div class="md:col-span-2">
          <label for="notes" class="block text-sm font-medium text-gray-700">หมายเหตุ</label>
          <textarea id="notes" name="notes" rows="3"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
        </div>
      </div>

      <!-- [UPDATED] Action Buttons -->
      <div class="mt-8 flex flex-col sm:flex-row gap-4">
        <!-- ปุ่ม Submit/Update -->
        <button type="submit" id="submitButton"
          class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span id="buttonText">บันทึกข้อมูล</span>
        </button>
        <!-- [NEW] ปุ่ม Cancel (ซ่อนไว้ก่อน) -->
        <button type="button" id="cancelButton"
          class="w-full sm:w-auto flex justify-center items-center py-3 px-6 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition hidden">
          ยกเลิก
        </button>
      </div>
    </form>
  </div>
  
  <!-- [NEW] Data Table Container -->
  <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl my-8 mx-auto" id="table-section">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">ข้อมูลลูกค้าทั้งหมด</h2>
    
    <!-- Container สำหรับตารางเพื่อให้เลื่อนแนวนอนได้บนมือถือ -->
    <div class="overflow-x-auto rounded-lg border border-gray-200 no-scrollbar">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ - สกุล</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ติดต่อ</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หมายเหตุ</th>
            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="customerTableBody">
          <!-- ข้อมูลจะถูกเติมโดย JavaScript -->
          <!-- Loading State -->
          <tr>
            <td colspan="5" class="px-6 py-12 text-center text-gray-500" id="loadingTable">
              กำลังโหลดข้อมูล...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center my-12 text-sm text-gray-500">
    Copyright © 2025, ABC จำกัด
  </footer>

  <!-- [UPDATED] Mockup และ JavaScript -->
  <script>
    // --- MOCKUP (สำหรับการทดสอบใน Local) ---
    // [UPDATED] ลบข้อมูลจำลอง (mockDB) ออกแล้ว
    if (typeof google === 'undefined' || typeof google.script === 'undefined') {
      console.warn("Google Apps Script API (google.script.run) not found. Mocking for local testing.");

      window.google = {
        script: {
          run: (function () {
            let successHandler = (response) => console.log("Mock Success:", response);
            let failureHandler = (error) => console.error("Mock Failure:", error);
            
            const runner = {
              withSuccessHandler: (handler) => { successHandler = handler; return runner; },
              withFailureHandler: (handler) => { failureHandler = handler; return runner; },
              
              // [UPDATED] จำลองฟังก์ชัน Backend (แบบไม่มีข้อมูล)
              getCustomerData: () => setTimeout(() => successHandler([]), 500), // ส่งอาร์เรย์ว่างกลับไป
              addCustomerData: (formData) => setTimeout(() => {
                successHandler({ status: "success", message: "บันทึกข้อมูล (Mock) สำเร็จ!" });
              }, 500),
              updateCustomerData: (request) => setTimeout(() => {
                successHandler({ status: "success", message: "อัปเดตข้อมูล (Mock) สำเร็จ!" });
              }, 500),
              deleteCustomerData: (rowNumber) => setTimeout(() => {
                successHandler({ status: "success", message: "ลบข้อมูล (Mock) สำเร็จ!" });
              }, 500)
            };
            return runner;
          }())
        }
      };
    }

    // --- MAIN SCRIPT ---

    // 1. ตัวแปรอ้างอิง DOM Elements
    const form = document.getElementById("customerForm");
    const submitButton = document.getElementById("submitButton");
    const buttonText = document.getElementById("buttonText");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const cancelButton = document.getElementById("cancelButton");
    const editingRowIdInput = document.getElementById("editingRowId");
    const tableBody = document.getElementById("customerTableBody");
    const loadingTable = document.getElementById("loadingTable");

    // 2. Event Listeners
    form.addEventListener("submit", handleFormSubmit);
    cancelButton.addEventListener("click", resetFormState);
    // เรียกโหลดข้อมูลเมื่อหน้าเว็บพร้อม
    document.addEventListener("DOMContentLoaded", loadCustomerData);

    
    /**
     * [NEW] โหลดข้อมูลลูกค้าทั้งหมดมาแสดงในตาราง
     */
    function loadCustomerData() {
      loadingTable.classList.remove("hidden");
      tableBody.innerHTML = ''; // ล้างตารางเก่า
      tableBody.appendChild(loadingTable);

      google.script.run
        .withSuccessHandler(buildCustomerTable)
        .withFailureHandler(onFailure) // ใช้ onFailure เดิมได้
        .getCustomerData();
    }

    /**
     * [NEW] สร้างตาราง HTML จากข้อมูลที่ได้รับ
     */
    function buildCustomerTable(data) {
      tableBody.innerHTML = ''; // ล้าง Loading...
      if (!data || data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">ไม่พบข้อมูลลูกค้า</td></tr>';
        return;
      }

      data.forEach(customer => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50";

        // ข้อมูล (stringified) สำหรับปุ่มแก้ไข
        const customerDataString = JSON.stringify(customer);

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${customer.firstName} ${customer.lastName}</div>
            <div class="text-sm text-gray-500">${customer.email}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${customer.phone}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${customer.customerType === 'vip' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
              ${customer.customerType}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate">${customer.notes || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button type="button" class="text-indigo-600 hover:text-indigo-900 mr-4 edit-btn" data-customer='${customerDataString}'>แก้ไข</button>
            <button type="button" class="text-red-600 hover:text-red-900 delete-btn" data-row="${customer.row}" data-name="${customer.firstName}">ลบ</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });

      // [NEW] เพิ่ม Event Listeners ให้ปุ่ม แก้ไข และ ลบ
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', handleEditClick);
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDeleteClick);
      });
    }

    /**
     * [UPDATED] จัดการการ Submit ฟอร์ม (ทั้งสร้างใหม่และอัปเดต)
     */
    function handleFormSubmit(e) {
      e.preventDefault();
      
      setLoadingState(true); // แสดงสถานะ Loading
      
      const formData = {
        firstName: form.firstName.value,
        lastName: form.lastName.value,
        phone: form.phone.value,
        email: form.email.value,
        customerType: form.customerType.value,
        notes: form.notes.value
      };

      const editingRowId = editingRowIdInput.value;

      if (editingRowId) {
        // --- โหมดอัปเดต ---
        const request = {
          row: editingRowId,
          data: formData
        };
        google.script.run
          .withSuccessHandler(onSuccess) // ใช้ onSuccess เดิมได้
          .withFailureHandler(onFailure)
          .updateCustomerData(request);
      } else {
        // --- โหมดสร้างใหม่ ---
        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onFailure)
          .addCustomerData(formData);
      }
    }

    /**
     * [NEW] เมื่อคลิกปุ่ม "แก้ไข"
     */
    function handleEditClick(e) {
      const customer = JSON.parse(e.target.dataset.customer);

      // 1. เติมข้อมูลลงในฟอร์ม
      form.firstName.value = customer.firstName;
      form.lastName.value = customer.lastName;
      form.phone.value = customer.phone;
      form.email.value = customer.email;
      form.customerType.value = customer.customerType;
      form.notes.value = customer.notes;
      
      // 2. เก็บ Row ID
      editingRowIdInput.value = customer.row;

      // 3. เปลี่ยนปุ่ม
      buttonText.textContent = "อัปเดตข้อมูล";
      cancelButton.classList.remove("hidden");

      // 4. เลื่อนจอขึ้นไปที่ฟอร์ม
      document.getElementById('form-section').scrollIntoView();
    }

    /**
     * [NEW] เมื่อคลิกปุ่ม "ลบ"
     */
    function handleDeleteClick(e) {
      const rowId = e.target.dataset.row;
      const name = e.target.dataset.name;

      Swal.fire({
        title: `ยืนยันการลบ`,
        text: `คุณต้องการลบข้อมูลของ "${name}" ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'ใช่, ลบเลย!',
        cancelButtonText: 'ยกเลิก'
      }).then((result) => {
        if (result.isConfirmed) {
          // แสดง Loading
          Swal.fire({
            title: 'กำลังลบ...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
          });
          
          google.script.run
            .withSuccessHandler(onSuccess) // ใช้ onSuccess เดิมได้ เพราะมันจะ reload ตาราง
            .withFailureHandler(onFailure)
            .deleteCustomerData(rowId);
        }
      });
    }

    /**
     * [UPDATED] ฟังก์ชันเมื่อทำงานสำเร็จ (สำหรับ Add, Update, Delete)
     */
    function onSuccess(response) {
      setLoadingState(false); // ปิดสถานะ Loading

      if (response.status === "success") {
        Swal.fire({
          icon: 'success',
          title: 'สำเร็จ!',
          text: response.message,
          timer: 2000,
          showConfirmButton: false
        });
        resetFormState(); // รีเซ็ตฟอร์ม
        loadCustomerData(); // โหลดตารางใหม่
      } else {
        // กรณี Backend ส่ง Error (เช่น catch(e))
        onFailure(response);
      }
    }

    /**
     * [UPDATED] ฟังก์ชันเมื่อทำงานล้มเหลว
     */
    function onFailure(error) {
      setLoadingState(false); // ปิดสถานะ Loading

      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด',
        text: error.message || 'ไม่สามารถติดต่อเซิร์ฟเวอร์ได้',
      });
    }

    /**
     * [NEW] รีเซ็ตสถานะฟอร์ม (ล้างค่าและเปลี่ยนปุ่มกลับ)
     */
    function resetFormState() {
      form.reset();
      editingRowIdInput.value = "";
      buttonText.textContent = "บันทึกข้อมูล";
      cancelButton.classList.add("hidden");
    }

    /**
     * [NEW] เปิด/ปิด สถานะ Loading ของปุ่ม Submit
     */
    function setLoadingState(isLoading) {
      if (isLoading) {
        submitButton.disabled = true;
        buttonText.textContent = editingRowIdInput.value ? "กำลังอัปเดต..." : "กำลังบันทึก...";
        loadingSpinner.classList.remove("hidden");
        // ปิด SweetAlert ที่อาจจะเปิดค้าง (เช่น Loading ตอนลบ)
        Swal.close(); 
      } else {
        submitButton.disabled = false;
        // ข้อความจะถูกตั้งค่าใหม่ใน resetFormState หรือ handleEditClick
        loadingSpinner.classList.add("hidden");
      }
    }
  </script>

</body>
</html>
